<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"><title>夜空堆塔游戏</title><link rel="icon" type="image/x-icon" href="./img/favicon.png"><style>*{margin:0;padding:0}img{width:100%}html{background:#fff;height:100%}body{font-family:"Helvetica Neue",Arial,Helvetica,sans-serif;margin:0 auto;text-align:center;width:100%;height:100%;background:#1a1f3a url(img/main-bg.png)}@media screen and (min-height:560px){html{font-size:100px}}@media screen and (min-height:640px){html{font-size:112.5px}}@media screen and (min-height:720px){html{font-size:125px}}@media screen and (min-height:800px){html{font-size:137.5px}}@media screen and (min-height:880px){html{font-size:150px}}@media screen and (min-height:960px){html{font-size:162.5px}}@media screen and (min-height:1040px){html{font-size:180px}}@media screen and (min-height:1200px){html{font-size:200px}}html{font-size:17.6vh}#canvas{position:fixed;left:0;top:0;right:0;bottom:0;margin:auto}a{text-decoration:none}li,ol,ul{list-style-type:none;padding:0;margin:0}.hide{display:none}.clear{clear:both}.loading{background:linear-gradient(135deg,#1a1f3a 0%,#2d1b4e 100%);height:100%;width:100%}.loading .main{width:60%;margin:0 auto;color:#fff}.loading .main img{width:60%;margin:1rem auto 0}.loading .main .title{font-size:.3rem}.loading .main .text{font-size:.15rem}.loading .main .bar{height:.12rem;width:100%;border:3px solid #fff;border-radius:.6rem;margin:.1rem 0}.loading .main .bar .sub{height:.1rem;width:98%;margin:.008rem auto 0}.loading .main .bar .percent{height:100%;width:0;background-color:#fff;border-radius:.6rem}.loading .logo{position:absolute;bottom:.3rem;left:0;right:0}.loading .logo img{width:1rem}.content{height:100vh;margin:0 auto;position:relative}.landing .title{width:60%}.landing .logo{width:30%;position:absolute;right:.2rem;top:.2rem}.landing .action-2{position:absolute;bottom:.2rem;width:100%}.landing .start{width:65%}.slideTop{-webkit-animation:st 1s ease-in-out;animation:st 1s ease-in-out}@-webkit-keyframes st{0%{transform:translateZ(0)}100%{transform:translate3d(0,-100%,0)}}@keyframes st{0%{transform:translateZ(0)}100%{transform:translate3d(0,-100%,0)}}.slideBottom{-webkit-animation:sb 1s ease-in-out;animation:sb 1s ease-in-out}@-webkit-keyframes sb{0%{transform:translateZ(0)}100%{transform:translate3d(0,200%,0)}}@keyframes sb{0%{transform:translateZ(0)}100%{transform:translate3d(0,200%,0)}}.swing{-webkit-animation:sw 2s ease-in-out alternate infinite;animation:sw 2s ease-in-out alternate infinite}@-webkit-keyframes sw{0%{transform:rotate(5deg);transform-origin:top center}100%{transform:rotate(-5deg);transform-origin:top center}}@keyframes sw{0%{transform:rotate(5deg);transform-origin:top center}100%{transform:rotate(-5deg);transform-origin:top center}}.modal .mask{background-color:#000;opacity:.6;position:fixed;height:100%;width:100%;top:0;left:0}.modal .modal-content{position:fixed;height:100%;width:90%;margin-top:.3rem;top:0}.modal .main{width:85%;margin:0 auto}.modal .container{position:relative}.modal .bg{width:100%;position:absolute;top:0;left:0}.modal .modal-main{width:100%;position:absolute;top:0;left:0;margin-top:-.4rem}.modal .over-img{width:80%;margin:.8rem auto 0}.modal .over-score{margin-top:-.2rem;font-size:.5rem;color:#ff735c;text-shadow:-2px -2px 0 #fff,2px -2px 0 #fff,-2px 2px 0 #fff,2px 2px 0 #fff}.modal .tip{font-size:.16rem;color:#9b724e}.modal .over-button-b{width:70%;margin:.1rem auto 0}.wxShare{background:#000;position:absolute;top:0;left:0;width:100%;height:100%;z-index:11;opacity:.9}.wxShare img{width:50%;float:right;margin:10px 10px 0 0}@font-face{font-family:wenxue;src:url(data:text/plain;base64,)}.font-wenxue{font-family:Arial,sans-serif}

/* 移动端优化样式 */
@media (max-width: 768px) {
    html { font-size: 14px !important; }
    body { touch-action: manipulation; }
    
    /* 虚拟控制器 */
    .virtual-controls {
        position: fixed;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        z-index: 1000;
        pointer-events: none;
    }
    
    .virtual-controls .control-button {
        width: 80px;
        height: 80px;
        margin: 0 10px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        pointer-events: auto;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
    }
    
    .virtual-controls .control-button:active,
    .virtual-controls .control-button.active {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(0.95);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .virtual-controls .control-button.special {
        background: rgba(255, 107, 107, 0.3);
        border-color: rgba(255, 107, 107, 0.6);
    }
    
    /* 游戏状态显示 */
    .game-status {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        z-index: 1000;
        color: white;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        pointer-events: none;
    }
    
    .game-status .score,
    .game-status .lives {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px 12px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
    }
    
    /* 优化canvas在移动端的显示 */
    #canvas {
        touch-action: none;
    }
    
    /* 隐藏桌面端的提示 */
    .desktop-only { display: none !important; }
}

@media (orientation: landscape) and (max-height: 500px) {
    .virtual-controls .control-button {
        width: 60px;
        height: 60px;
        font-size: 20px;
        margin: 0 5px;
    }
    
    .game-status {
        top: 10px;
        left: 10px;
        right: 10px;
    }
    
    .game-status .score,
    .game-status .lives {
        padding: 6px 10px;
        font-size: 14px;
    }
}

/* 高分辨率屏幕优化 */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .virtual-controls .control-button {
        border-width: 1px;
    }
}</style></head><body><canvas id="canvas" class="hide"></canvas><div class="content"><div class="loading"><div class="main"><img src="./img/main-loading.gif"><div class="progress"><div class="title font-wenxue">0%</div><div class="bar"><div class="sub"><div class="percent"></div></div></div><div class="text">Loading...</div></div></div></div><div class="landing hide"><div class="action-1"><img src="./img/main-index-title.png" class="title swing"></div><div class="action-2"><img id="start" src="./img/main-index-start.png" class="start"></div></div><div id="modal" class="modal hide"><div class="mask"></div><div class="js-modal-content modal-content"><div class="main"><div class="container"><img src="./img/main-modal-bg.png" class="bg"><div class="modal-main"><div id="over-modal" class="hide js-modal-card"><img src="./img/main-modal-over.png" class="over-img"><div id="score" class="over-score font-wenxue"></div><div id="over-zero" class="hide"><div class="tip"><p>Try Again!</p><img src="./img/main-modal-again-b.png" class="over-button-b js-reload"><img src="./img/main-modal-invite-b.png" class="over-button-b js-invite"></div></div></div></div></div></div></div></div><div class="wxShare hide"><img src="./img/main-share-icon.png"></div></div>

<!-- 移动端虚拟控制器和状态显示 -->
<div class="virtual-controls" id="virtualControls" style="display: none;">
    <button class="control-button" id="dropBtn" title="放下方块">⬇️</button>
    <button class="control-button special" id="pauseBtn" title="暂停">⏸️</button>
</div>

<div class="game-status" id="gameStatus" style="display: none;">
    <div class="score">分数: <span id="mobileScore">0</span></div>
    <div class="lives">生命: <span id="mobileLives">3</span></div>
</div><script src="./js/main.js"></script><script src="./js/zepto-1.1.6.min.js"></script><script>var domReady, loadFinish, canvasReady, loadError, gameStart, game, score, successCount
  // init window height and width
  var gameWidth = window.innerWidth
  var gameHeight = window.innerHeight
  var ratio = 1.5
  if (gameHeight / gameWidth < ratio) {
    gameWidth = Math.ceil(gameHeight / ratio)
  }
  $('.content').css({ "height": gameHeight + "px", "width": gameWidth + "px" })
  $('.js-modal-content').css({ "width": gameWidth + "px" })

  // loading animation
  function hideLoading() {
    if (domReady && canvasReady) {
      $('#canvas').show()
      loadFinish = true
      setTimeout(function () {
        $('.loading').hide()
        $('.landing').show()
      }, 1000)
    }
  }

  function updateLoading(status) {
    var success = status.success
    var total = status.total
    var failed = status.failed
    if (failed > 0 && !loadError) {
      loadError = true
      alert('Network error... Please try again.')
      return
    }
    var percent = parseInt((success / total) * 100);
    if (percent === 100 && !canvasReady) {
      canvasReady = true
      hideLoading()
    }
    percent = percent > 98 ? 98 : percent
    percent = percent + '%'
    $('.loading .title').text(percent);
    $('.loading .percent').css({
      'width': percent
    })
  }

  function overShowOver() {
    $('#modal').show()
    $('#over-modal').show()
    $('#over-zero').show()
  }

  // 游戏配置选项
  const option = {
    width: gameWidth,
    height: gameHeight,
    canvasId: 'canvas',
    soundOn: false,
    setGameScore: function (s) {
      score = s
    },
    setGameSuccess: function (s) {
      successCount = s
    },
    setGameFailed: function (f) {
      $('#score').text(score)
      if (f >= 3) overShowOver()
    }
  }

  // game init with option
  function gameReady() {
    game = TowerGame(option)
    game.load(function () {
      game.init()
      setTimeout(function () {
        game.playBgm()
      })
    }, updateLoading)
  }

  var isWechat = navigator.userAgent.toLowerCase().indexOf("micromessenger") !== -1
  if (isWechat) {
    document.addEventListener("WeixinJSBridgeReady", gameReady, false)
  } else {
    gameReady()
  }

  function indexHide() {
    $('.landing .action-1').addClass('slideTop')
    $('.landing .action-2').addClass('slideBottom')
    setTimeout(function () {
      $('.landing').hide()
    }, 950)
  }

  // click event
  $('#start').on('click', function () {
    if (gameStart) return
    gameStart = true
    setTimeout(function () {
      game.playBgm()
    })
    indexHide()
    setTimeout(game.start, 400)
  })

  $('.js-reload').on('click', function () {
    window.location.href = window.location.href + '?s=' + (+new Date())
  })

  $('.js-invite').on('click', function () {
    $('.wxShare').show()
  })

  $('.wxShare').on('click', function () {
    $('.wxShare').hide()
  })

  // 移动端优化
  function initMobileOptimization() {
    // 检测移动设备
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
      // 显示虚拟控制器和游戏状态
      $('#virtualControls, #gameStatus').show();
      
      // 初始化虚拟控制器
      initVirtualControls();
      
      // 监听分数和生命值变化
      updateMobileStatus();
      
      // 禁用页面滚动
      document.addEventListener('touchmove', function(e) {
        if (e.target.closest('.virtual-controls')) return;
        e.preventDefault();
      }, { passive: false });
      
      // 优化触摸响应
      document.body.style.touchAction = 'manipulation';
      
      // 处理屏幕方向变化
      window.addEventListener('orientationchange', function() {
        setTimeout(function() {
          window.scrollTo(0, 0);
        }, 100);
      });
    }
  }
  
  // 初始化虚拟控制器
  function initVirtualControls() {
    // 放下方块按钮
    $('#dropBtn').on('touchstart', function(e) {
      e.preventDefault();
      if (game && gameStart) {
        // 触发游戏中的触摸事件
        game.touchStartListener && game.touchStartListener();
        $(this).addClass('active');
      }
    }).on('touchend', function(e) {
      e.preventDefault();
      $(this).removeClass('active');
    });
    
    // 暂停按钮
    $('#pauseBtn').on('touchstart', function(e) {
      e.preventDefault();
      $(this).addClass('active');
      
      if (game && game.debug) {
        game.togglePaused();
      }
      
      setTimeout(() => {
        $(this).removeClass('active');
      }, 200);
    });
    
    // 防止双击缩放
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  }
  
  // 更新移动端状态显示
  function updateMobileStatus() {
    // 监听分数变化
    const originalSetGameScore = option.setGameScore;
    option.setGameScore = function(s) {
      score = s;
      $('#mobileScore').text(score);
      if (originalSetGameScore) originalSetGameScore(s);
    };
    
    // 监听生命值变化
    const originalSetGameFailed = option.setGameFailed;
    option.setGameFailed = function(f) {
      const livesLeft = Math.max(0, 3 - f);
      $('#mobileLives').text(livesLeft);
      if (originalSetGameFailed) originalSetGameFailed(f);
    };
    
    // 初始化显示
    $('#mobileScore').text(score || 0);
    $('#mobileLives').text(3);
  }
  
  // 监听窗口大小变化，调整canvas
  function adjustCanvasForMobile() {
    const canvas = document.getElementById('canvas');
    if (canvas && window.innerWidth <= 768) {
      const ratio = window.innerWidth / window.innerHeight;
      if (ratio > 1) {
        // 横屏模式
        canvas.style.width = '100vw';
        canvas.style.height = '100vh';
      } else {
        // 竖屏模式
        canvas.style.width = '100vw';
        canvas.style.height = '100vh';
      }
    }
  }
  
  // 页面加载完成后初始化移动端优化
  $(document).ready(function() {
    initMobileOptimization();
    adjustCanvasForMobile();
  });
  
  // 监听窗口大小变化
  window.addEventListener('resize', adjustCanvasForMobile);

  // listener
  window.addEventListener('load', function () {
    domReady = true
    hideLoading()
    
    // 初始化全屏功能
    if (window.FullscreenUtils) {
        FullscreenUtils.initFullscreen('canvas', '塔楼游戏');
    }
  }, false);</script></body></html>